==============================
URL DE PRODUCCIN PARA EL FRONTEND
==============================

El frontend debe consumir los endpoints del backend usando la siguiente URL p煤blica de Railway:

https://expense-control-backend-pruebas.up.railway.app

Todos los endpoints documentados deben ser accedidos anteponiendo esta URL base. Ejemplo:
- Para obtener la clave p煤blica VAPID: https://expense-control-backend-pruebas.up.railway.app/api/notifications/public-key
- Para suscribirse: https://expense-control-backend-pruebas.up.railway.app/api/notifications/subscribe

Esta es la URL que se observa en la configuraci贸n de Railway y es la que debe usarse en producci贸n para que el frontend se comunique correctamente con el backend desplegado.

==============================
DEFINICIONES CLAVE
==============================

**驴Qu茅 son las claves VAPID?**
VAPID (Voluntary Application Server Identification) es un est谩ndar que permite a los servidores de aplicaciones web identificarse ante los servicios de push (como los navegadores) cuando env铆an notificaciones push. Consiste en un par de claves (p煤blica y privada):
- La clave p煤blica se comparte con el frontend y se usa para suscribirse a notificaciones.
- La clave privada permanece en el backend y se utiliza para firmar los mensajes, asegurando que provienen de un servidor autorizado.
Esto ayuda a proteger el canal de notificaciones y a evitar env铆os no autorizados.

**驴Qu茅 es el rate limiting?**
El rate limiting es una t茅cnica de seguridad que limita la cantidad de solicitudes que un usuario o cliente puede hacer a un endpoint en un periodo de tiempo determinado. Su objetivo es prevenir abusos, como ataques de fuerza bruta, spam o sobrecarga del servidor. Por ejemplo, se puede permitir solo 100 solicitudes por minuto por usuario/IP. Si se supera ese l铆mite, el servidor rechaza las solicitudes adicionales temporalmente.

==============================
ANLISIS DE SEGURIDAD (ENERO 2026)
==============================

Resumen general:
El sistema de notificaciones push implementado en este backend utiliza Node.js/Express, Supabase como base de datos y la librer铆a web-push para la gesti贸n de claves VAPID y el env铆o de notificaciones. Se han implementado endpoints protegidos por middleware de autenticaci贸n y validaci贸n de tokens, y se han seguido buenas pr谩cticas en la validaci贸n de datos y manejo de errores.

Puntos fuertes:
- **Autenticaci贸n:** Los endpoints sensibles (suscripci贸n/desuscripci贸n, cron) requieren token JWT v谩lido.
- **Validaci贸n de datos:** Se valida la estructura de los objetos de suscripci贸n y los datos recibidos en los endpoints.
- **Gesti贸n de claves:** Las claves VAPID se mantienen en variables de entorno y no se exponen en el c贸digo fuente.
- **Automatizaci贸n segura:** El endpoint de cron para notificaciones autom谩ticas requiere un token especial y no est谩 expuesto p煤blicamente.
- **Manejo de errores:** Se implementan respuestas claras y manejo de errores para evitar fugas de informaci贸n.

reas de mejora y riesgos:
- **Almacenamiento de suscripciones:** Las suscripciones se almacenan en Supabase, pero no se cifra el campo de suscripci贸n (aunque no suele ser necesario, podr铆a considerarse para mayor privacidad).
- **Rotaci贸n de claves VAPID:** No se ha documentado un proceso de rotaci贸n peri贸dica de claves VAPID.
- **Protecci贸n contra abuso:** No hay l铆mites de rate limiting en los endpoints, lo que podr铆a permitir ataques de fuerza bruta o spam.
- **Auditor铆a y logs:** No se ha detallado un sistema de auditor铆a/logs para monitorear accesos y acciones sospechosas.
- **Actualizaci贸n de dependencias:** Es importante mantener actualizadas las dependencias npm para evitar vulnerabilidades conocidas.
- **CORS:** Se debe revisar la configuraci贸n de CORS para asegurar que solo el frontend autorizado pueda consumir los endpoints.

Calificaci贸n de seguridad actual (estimada):
**75%**

El sistema cumple con los est谩ndares b谩sicos de seguridad para una API de notificaciones push, pero a煤n existen 谩reas de mejora para alcanzar un nivel 贸ptimo (90%+), especialmente en cuanto a protecci贸n contra abuso, monitoreo y rotaci贸n de claves.

Recomendaciones para subir la calificaci贸n:
- Implementar rate limiting en los endpoints.
- Documentar y aplicar rotaci贸n de claves VAPID.
- A帽adir logs de auditor铆a para acciones cr铆ticas.
- Revisar y restringir CORS.
- Mantener dependencias actualizadas y monitorear vulnerabilidades.

---

## 10. Endpoints que debe contemplar el frontend para notificaciones push

- **Obtener clave p煤blica VAPID:**
  - `GET /api/notifications/public-key`
  - Uso: El frontend debe llamar a este endpoint para obtener la clave p煤blica y poder suscribirse a notificaciones push.

- **Registrar suscripci贸n push:**
  - `POST /api/notifications/subscribe`
  - Uso: El frontend debe enviar el objeto de suscripci贸n `{ endpoint, keys }` junto con el JWT del usuario autenticado para registrar la suscripci贸n en el backend.
  - Headers: `Authorization: Bearer <JWT>`
  - Body ejemplo:
    ```json
    {
      "endpoint": "https://fcm.googleapis.com/fcm/send/...",
      "keys": {
        "p256dh": "...",
        "auth": "..."
      }
    }
    ```

- **Eliminar/desuscribir suscripci贸n push:**
  - `POST /api/notifications/unsubscribe`
  - Uso: El frontend debe enviar el `endpoint` de la suscripci贸n a eliminar, junto con el JWT del usuario autenticado.
  - Headers: `Authorization: Bearer <JWT>`
  - Body ejemplo:
    ```json
    {
      "endpoint": "https://fcm.googleapis.com/fcm/send/..."
    }
    ```

- **(Autom谩tico, no lo llama el frontend)**
  - `POST /api/notifications/cron/send`
  - Uso: Endpoint que solo llama Supabase Cron para disparar notificaciones autom谩ticas. El frontend no debe consumirlo.

---
# Reporte de Cambios Backend: Notificaciones Push Autom谩ticas

Fecha: 19/01/2026
Proyecto: Expense-Control-BackEnd

---

## 1. Estructura y l贸gica implementada

- Se integr贸 un sistema de notificaciones push web usando web-push y Supabase.
- Se eliminaron dependencias de servicios externos (OneSignal, etc.).
- Se automatiz贸 el env铆o de notificaciones de engagement (motivacionales, recordatorios, res煤menes) mediante cron jobs (Supabase y/o node-cron).
- No se env铆an notificaciones de presupuesto ni de expiraci贸n de suscripci贸n (solo engagement).

---

## 2. Cambios en la base de datos (Supabase)

- Tabla creada: **push_subscriptions**
  - Columnas: id, idusuario (bigint, min煤sculas), subscription (jsonb), created_at
  - El campo `subscription` almacena el objeto completo de la suscripci贸n push (endpoint, keys, etc.)

---

## 3. Archivos nuevos y modificados en el backend

- **src/services/push.service.js**
  - L贸gica para inicializar VAPID, enviar notificaciones, construir payloads y enviar a usuarios/broadcast.
  - Correcci贸n: uso de `idusuario` (min煤sculas) en todas las consultas.
  - Validaciones seguras sin optional chaining (compatibles con cualquier Node.js).

- **src/controllers/notifications.controller.js**
  - Endpoints para suscribirse/desuscribirse y obtener la clave p煤blica VAPID.
  - Validaciones corregidas para evitar errores de sintaxis.

- **src/controllers/cron.controller.js**
  - Endpoint para recibir llamadas autom谩ticas desde Supabase Cron y enviar notificaciones de engagement.
  - Validaci贸n segura del token de autorizaci贸n.

- **src/routes/notifications.routes.js**
  - Rutas para suscripci贸n, desuscripci贸n, obtenci贸n de clave p煤blica y endpoint de cron.

- **src/app.js**
  - Importaci贸n y uso de las rutas de notificaciones.
  - Inicializaci贸n de VAPID.
  - (Opcional) Inicializaci贸n de cron jobs locales para pruebas.

---

## 4. Cambios en l贸gica y validaciones

- Todas las validaciones de propiedades usan la forma cl谩sica:
  - Ejemplo: `if (!subscription || !subscription.endpoint) { ... }`
- Todas las consultas a la tabla `push_subscriptions` usan `idusuario` (min煤sculas).
- Todas las validaciones de token y propiedades usan `&&` en vez de optional chaining.

---

## 5. Adaptaciones para el frontend

- El frontend debe:
  - Solicitar la clave p煤blica VAPID desde `/api/notifications/public-key`.
  - Registrar la suscripci贸n push en el backend usando `/api/notifications/subscribe` (enviar `{ endpoint, keys }`).
  - Permitir desuscribirse usando `/api/notifications/unsubscribe`.
  - Esperar notificaciones push con payload est谩ndar:
    - `{ notification: { title, body, icon, badge, tag }, data: { ... } }`
- No se requiere l贸gica de presupuesto ni expiraci贸n en el frontend para este proceso.

---

## 6. Ejemplo de payload de notificaci贸n

```json
{
  "notification": {
    "title": " Recordatorio",
    "body": "No olvides registrar tus gastos de hoy",
    "icon": "/logo.png",
    "badge": "/badge.png",
    "tag": "engagement"
  },
  "data": {
    "action": "openGastos"
  }
}
```

---

## 7. Recomendaciones para el frontend

- Usar Service Worker para recibir y mostrar notificaciones push.
- Solicitar permisos de notificaci贸n al usuario.
- Registrar/desregistrar la suscripci贸n en el backend seg煤n el estado del usuario.
- Manejar el payload recibido y mostrar la notificaci贸n con los datos enviados.

---

## 8. Notas finales

- El backend est谩 listo para recibir y enviar notificaciones push autom谩ticas de engagement.
- Todos los endpoints y l贸gica est谩n adaptados para m谩xima compatibilidad y seguridad.
- Si el frontend necesita ejemplos de integraci贸n, puede pedirlos aqu铆.

---

Fin del reporte.


---

## 9. 驴C贸mo se espera que el usuario interact煤e con las notificaciones?

- **Recepci贸n:**
  - El usuario debe aceptar recibir notificaciones push en el frontend (PWA o web app).
  - Una vez suscrito, el backend enviar谩 notificaciones autom谩ticas de engagement (recordatorios, motivacionales, res煤menes) seg煤n la programaci贸n definida.

- **Visualizaci贸n:**
  - Las notificaciones aparecer谩n como mensajes push en el navegador o dispositivo, incluso si la app no est谩 abierta.
  - El usuario ver谩 el t铆tulo, cuerpo, icono y, opcionalmente, una imagen o badge.

- **Acci贸n:**
  - Al hacer clic en la notificaci贸n, el Service Worker del frontend debe manejar el evento y redirigir al usuario a la secci贸n relevante de la app (por ejemplo, abrir la pantalla de registro de gastos, dashboard, etc.), usando el campo `data.action` del payload.
  - Ejemplo: Si `data.action` es `openGastos`, el frontend debe navegar a la vista de gastos.

- **Desuscripci贸n:**
  - El usuario puede desactivar las notificaciones desde la app, lo que eliminar谩 su suscripci贸n en el backend.

- **Requisitos t茅cnicos en frontend:**
  - Implementar un Service Worker que escuche y muestre las notificaciones push.
  - Manejar el evento `notificationclick` para realizar la acci贸n adecuada seg煤n el payload recibido.
  - Gestionar el registro y eliminaci贸n de la suscripci贸n push seg煤n el estado del usuario (login/logout, preferencias, etc.).

---

**Resumen:**
El usuario solo debe aceptar las notificaciones una vez. A partir de ah铆, recibir谩 mensajes autom谩ticos de engagement y podr谩 interactuar con ellos para volver a la app y realizar acciones sugeridas, mejorando la retenci贸n y el uso de la plataforma.
